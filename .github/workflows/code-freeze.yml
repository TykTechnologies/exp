# yamllint disable rule:line-length
---
name: Code Freeze Branch Creation

run-name: 'Creating ${{ inputs.destination_branch }} from ${{ inputs.source_branch }} by ${{ github.actor }}'

# This workflow creates code freeze branches across multiple repositories.
# It creates the same branch in all specified repositories from the specified source branch.

on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
    inputs:
      repositories:
        description: 'Repositories to create branch in'
        required: true
        type: choice
        options:
          - tyk-core-products (tyk, tyk-analytics, tyk-analytics-ui)
          - tyk-sink
          - tyk-pump
          - portal
          - tyk-operator-internal
          - tyk-sync-internal
      source_branch:
        description: 'Source Branch (branch to create from)'
        required: true
      destination_branch:
        description: 'Destination Branch (branch to create)'
        required: true
      notify_slack:
        description: 'Send Slack notification when complete'
        type: boolean
        default: false

env:
  GITHUB_TOKEN: ${{ secrets.ORG_GH_TOKEN }}

jobs:
  create-branches:
    name: Create branches in selected repositories
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build repository list
        id: build-repo-list
        run: |
          # Initialize empty array
          REPOS=()

          # Add repositories based on dropdown selection
          SELECTION="${{ github.event.inputs.repositories }}"
          if [[ "$SELECTION" == tyk-core-products* ]]; then
            REPOS+=("tyk" "tyk-analytics" "tyk-analytics-ui")
          elif [ "$SELECTION" = "tyk-sink" ]; then
            REPOS+=("tyk-sink")
          elif [ "$SELECTION" = "tyk-pump" ]; then
            REPOS+=("tyk-pump")
          elif [ "$SELECTION" = "portal" ]; then
            REPOS+=("portal")
          elif [ "$SELECTION" = "tyk-operator-internal" ]; then
            REPOS+=("tyk-operator-internal")
          elif [ "$SELECTION" = "tyk-sync-internal" ]; then
            REPOS+=("tyk-sync-internal")
          fi
          
          # Convert array to JSON
          JSON_ARRAY=$(jq -nc '$ARGS.positional' --args -- "${REPOS[@]}")
          echo "repositories=$JSON_ARRAY" >> "$GITHUB_OUTPUT"
          
          # Create a comma-separated list for display
          REPOS_CSV=$(IFS=,; echo "${REPOS[*]}")
          echo "repositories_csv=$REPOS_CSV" >> "$GITHUB_OUTPUT"
          
          # Create Slack-formatted repository links
          REPOS_LINKS=""
          DEST_BRANCH_VAR="${{ github.event.inputs.destination_branch }}"
          for repo in "${REPOS[@]}"; do
            REPOS_LINKS="${REPOS_LINKS}- <https://github.com/TykTechnologies/${repo}/tree/${DEST_BRANCH_VAR} | ${repo}>\n"
          done
          echo "repositories_links<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$REPOS_LINKS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create branches
        env:
          GH_TOKEN: ${{ secrets.ORG_GH_TOKEN }}
          SOURCE_BRANCH: ${{ github.event.inputs.source_branch }}
          DEST_BRANCH: ${{ github.event.inputs.destination_branch }}
        run: |
          # Get repositories as JSON array
          REPOSITORIES='${{ steps.build-repo-list.outputs.repositories }}'
          
          # Loop through each repository
          echo "$REPOSITORIES" | jq -c '.[]' | while read -r repo; do
            # Remove quotes from repo name
            repo=$(echo "$repo" | tr -d '"')
            echo "Creating branch for repository: $repo"
            
            # Clone repository
            git clone --depth 1 --branch "$SOURCE_BRANCH" "https://$GH_TOKEN@github.com/TykTechnologies/$repo.git"
            cd "$repo"
            
            # Create and push new branch
            git checkout -b "$DEST_BRANCH"
            git push origin "$DEST_BRANCH"
            
            echo "âœ… Created branch $DEST_BRANCH in $repo"
            cd ..
            
            # Clean up
            rm -rf "$repo"
          done

      - name: Send Slack notification
        if: ${{ github.event.inputs.notify_slack == 'true' }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: '#team-ext-engineering-pr-notifications'
          slack-message: |
            *Code Freeze Branches Created*
            
            Branch `${{ github.event.inputs.destination_branch }}` was created from `${{ github.event.inputs.source_branch }}` in the following repositories:
            
            ${{ steps.build-repo-list.outputs.repositories_links }}
            
            Triggered by: ${{ github.actor }}
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.UI_SLACK_AUTH_TOKEN }}
