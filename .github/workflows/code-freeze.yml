# yamllint disable rule:line-length
---
name: Code Freeze Branch Creation

run-name: 'Creating ${{ inputs.destination_branch }} from ${{ inputs.source_branch }} by ${{ github.actor }}'

# This workflow creates code freeze branches across multiple repositories.
# It creates the same branch in all specified repositories from the specified source branch.

on:  # yamllint disable-line rule:truthy
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source Branch (branch to create from)'
        required: true
        default: 'master'
      destination_branch:
        description: 'Destination Branch (branch to create)'
        required: true
        default: 'release-5.8'
      repository_selection:
        description: 'Select repositories to create the branch in'
        required: true
        type: choice
        options:
          - 'tyk-core-products'
          - 'tyk-sink'
          - 'tyk-sync-internal'
          - 'tyk-operator-internal'
          - 'tyk-charts'
          - 'portal'
          - 'tyk-pump'
        default: 'tyk-core-products'
      notify_slack:
        description: 'Send Slack notification when complete'
        type: boolean
        default: false

env:
  GITHUB_TOKEN: ${{ secrets.ORG_GH_TOKEN }}

jobs:
  create-branches:
    name: Create branches in all repositories
    runs-on: ubuntu-latest
    outputs:
      repositories_links: ${{ steps.build-repo-list.outputs.repositories_links }}
    steps:
      - name: Validate inputs
        run: |
          if [ -z "${{ github.event.inputs.destination_branch }}" ]; then
            echo "Destination branch cannot be empty"
            exit 1
          fi

          echo "Creating branch ${{ github.event.inputs.destination_branch }} from ${{ github.event.inputs.source_branch }}"
          echo "source_branch=${{ github.event.inputs.source_branch }}" >> $GITHUB_ENV
          echo "destination_branch=${{ github.event.inputs.destination_branch }}" >> $GITHUB_ENV

      - name: Build repository list
        id: build-repo-list
        run: |
          REPOS=()

          case "${{ github.event.inputs.repository_selection }}" in
            "tyk-core-products")
              REPOS+=("tyk")
              REPOS+=("tyk-analytics")
              REPOS+=("tyk-analytics-ui")
              ;;
            "tyk-sink")
              REPOS+=("tyk-sink")
              ;;
            "tyk-sync-internal")
              REPOS+=("tyk-sync-internal")
              ;;
            "tyk-operator-internal")
              REPOS+=("tyk-operator-internal")
              ;;
            "tyk-charts")
              REPOS+=("tyk-charts")
              ;;
            "portal")
              REPOS+=("portal")
              ;;
            "tyk-pump")
              REPOS+=("tyk-pump")
              ;;
            *)
              echo "::error::Invalid repository selection: ${{ github.event.inputs.repository_selection }}"
              exit 1
              ;;
          esac

          JSON_ARRAY=$(jq -nc '$ARGS.positional' --args -- "${REPOS[@]}")
          echo "repositories=$JSON_ARRAY" >> "$GITHUB_OUTPUT"

          REPOS_LINKS=""
          DEST="${{ github.event.inputs.destination_branch }}"
          for repo in "${REPOS[@]}"; do
            REPOS_LINKS="${REPOS_LINKS}- <https://github.com/TykTechnologies/${repo}/tree/${DEST}|${repo}>\n"
          done
          echo "repositories_links<<EOF" >> "$GITHUB_OUTPUT"
          echo -e "$REPOS_LINKS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Create branches
        run: |
          REPOSITORIES='${{ steps.build-repo-list.outputs.repositories }}'

          echo "$REPOSITORIES" | jq -c '.[]' | while read -r repo; do
            repo=$(echo "$repo" | tr -d '"')
            echo "Creating branch ${{ env.destination_branch }} in $repo"
            git clone --depth 1 --branch ${{ env.source_branch }} https://${{ secrets.ORG_GH_TOKEN }}@github.com/TykTechnologies/${repo}.git
            cd "$repo"
            git checkout -b ${{ env.destination_branch }}
            git push origin ${{ env.destination_branch }}
            echo "âœ… Created branch ${{ env.destination_branch }} in $repo"
            cd ..
          done

  notify:
    name: Send notifications
    needs: [create-branches]
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification
        if: ${{ github.event.inputs.notify_slack == 'true' }}
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: '#team-ext-engineering-pr-notifications'
          slack-message: |
            *Code Freeze Branches Created*

            Branch `${{ github.event.inputs.destination_branch }}` was created from `${{ github.event.inputs.source_branch }}` in the following repositories:

            ${{ needs.create-branches.outputs.repositories_links }}

            Triggered by: ${{ github.actor }}
            Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.UI_SLACK_AUTH_TOKEN }}
